!function(e,t){"use strict";"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=t(require("jquery")):e.topoViewer=t(e.jQuery)}(this,function(h){var t="undefined"!=typeof window?window.document:{},n={root:"static/plugins/topoViewer/",imageDir:"images/",background:"background.jpg",url:null,dataDir:"data/",data:"data.json",scale:1},s=function(s,i){if(!s||!i)return s;var a=/{(.*?)}/g,e=s.match(a);return h.each(e,function(e,t){var n=t.replace(a,"$1"),r=i[n];void 0!==r&&(s=s.replace(t,r))}),s},r=function(e,t,n){var r=Math.pow(10,t);return Math.round(e*r*(n?100:1))/r},i={name:"topoViewer",props:{mxGraph:{cellsResizable:!1,cellsEditable:!1,edgeLabelsMovable:!1,allowDanglingEdges:!1},mxConsts:{DEFAULT_FONTFAMILY:"Helvetica,Arial",VERTEX_SELECTION_COLOR:"#FF0000",EDGE_SELECTION_COLOR:"#FF0000",VERTEX_SELECTION_STROKEWIDTH:2,EDGE_SELECTION_STROKEWIDTH:2},cellHighlightColor:"#00FF00",cellStyle:{snc:{name:"snc",img:"snc.png"},snc_error:{name:"snc_error",img:"snc_error.png"},router:{name:"router",img:"router.png"},router_error:{name:"router_error",img:"router_error.png"},fp:{name:"fp",img:"fp.png"},fp_error:{name:"fp_error",img:"fp_error.png"}},groupStyle:{circle:"circle",rectangle:"rectangle",cloud:"cloud"},linkStyle:{link:"link",link_error:"link_error"},deviceCategory:{snc:"Server",router:"Router",fp:"Switch"},lengend:[{name:"SNC",cls:"snc"},{name:"S-Router",cls:"router"},{name:"FP",cls:"fp"}],inspectStatus:[{cname:"致命",cls:"fatal"},{cname:"严重",cls:"serious"},{cname:"一般",cls:"commonly"}],inspectLevel:{fatal:0,serious:1,commonly:2},arrange:{grid:"grid",circle:"circle"}},init:function(e){h(t.body).addClass(this.name+"-body"),e.$el.addClass(this.name),this.initGraph(e)},initGraph:function(e){var t=e.options,n=e.dom,r=e.graph=new mxGraph(n),s=this.props;h.extend(r,s.mxGraph),h.extend(mxConstants,s.mxConsts),new mxRubberband(r),new mxCellTracker(r,s.cellHighlightColor),mxEvent.disableContextMenu(n),r.zoomTo(t.scale),this.initProps(e),this.setBackground(e),this.setLengend(e),this.setStatus(e),this.configureStylesheet(e),this.getTooltipForCell(r),this.getLabel(r),this.draw(e)},initProps:function(e){var t=e.graph,n=t.getModel(),r=e.options,s=r.root,i=s+r.imageDir;e.mxHelper=new a(n,t),e.sourceData={devices:[],links:[]},e.path={imgDir:i,background:i+r.background,data:s+r.dataDir+r.data}},setBackground:function(e){var t=e.path.background;e.$el.after(s('<img class="topo-bg" / src="{bg}">',{bg:t}))},getLabel:function(e){e.getLabel=function(e){return e.value&&e.value.label}},getTooltipForCell:function(e){this.props.groupStyle;var n=function(e){var n="";return h.each(e.inspectResult,function(e,t){n+=s('<div class="col-xs-4 error">{name}</div><div class="col-xs-8 error">{msg}</div>',t)}),e.InspectMessage=n,e};e.setTooltips(!0),e.getTooltipForCell=function(e){var t=e.value;if(t){if(e.edge){if(!(t=n(t)).InspectMessage)return;return s('<div class="row topo-cell-tooltip">{InspectMessage}</div>',t)}if(!e.group)return t=n(t),s('<div class="row topo-cell-tooltip"><div class="col-xs-4">名称</div><div class="col-xs-8">{Name}</div><div class="col-xs-4">IP</div><div class="col-xs-8">{IP}</div>{InspectMessage}</div>',t)}}},setLengend:function(e){var n=h('<ul class="topoLegend"></ul>').insertAfter(e.$el);h.each(this.props.lengend,function(e,t){n.append(s('<li class="{cls}"><span class="icon"></span><span class="text">{name}</span></li>',t))})},setStatus:function(e){var n=h('<div class="divStatus"></div>').insertAfter(e.$el),t=this.props.inspectStatus,r=this.props.inspectLevel;h.each(t,function(e,t){t.level=r[t.cls],n.append(s('<div class="status {cls}" data-level="{level}"><span class="text">{cname}</span><span class="value">0</span></div>',t))})},configureStylesheet:function(e){var s=e.path.imgDir,t=this.props.cellStyle,n=this.props.linkStyle,r=this.props.groupStyle,i=e.graph.getStylesheet();h.each(t,function(e,t){var n,r;n=t,(r={})[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_IMAGE,r[mxConstants.STYLE_IMAGE]=s+n.img,r[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,r[mxConstants.STYLE_VERTICAL_LABEL_POSITION]=mxConstants.ALIGN_BOTTOM,i.putCellStyle(n.name,r)});var a={};a[mxConstants.STYLE_STROKECOLOR]="rgba(0,155,77,0.5)",a[mxConstants.STYLE_STROKEWIDTH]=2,a[mxConstants.STYLE_FONTSTYLE]=3,a[mxConstants.STYLE_PERIMETER_SPACING]=2,a[mxConstants.STYLE_ENDARROW]="",i.putCellStyle(n.link,a);var l=h.extend({},a);l[mxConstants.STYLE_STROKECOLOR]="rgba(219,25,33,0.6)",i.putCellStyle(n.link_error,l);var o={};o[mxConstants.STYLE_FILLCOLOR]="rgba(255,255,255,0.1)",o[mxConstants.STYLE_FONTSIZE]=0,o[mxConstants.STYLE_FONTCOLOR]="#f6f7e3",o[mxConstants.STYLE_VERTICAL_ALIGN]=mxConstants.ALIGN_TOP,o[mxConstants.STYLE_ALIGN]=mxConstants.ALIGN_LEFT,o[mxConstants.STYLE_SPACING_LEFT]=10,o[mxConstants.STYLE_SPACING_RIGHT]=10,o[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_ELLIPSE,i.putCellStyle(r.circle,o);var c=h.extend({},o);c[mxConstants.STYLE_FONTSIZE]=20,c[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_RECTANGLE,i.putCellStyle(r.rectangle,c);var u=h.extend({},o);u[mxConstants.STYLE_FONTSIZE]=20,u[mxConstants.STYLE_SHAPE]=mxConstants.SHAPE_CLOUD,i.putCellStyle(r.cloud,u)},draw:function(n){var r=this,t=1,s=function(e){h.ajax({method:e||"GET",url:n.options.url||n.path.data+"?ts="+(new Date).valueOf(),dataType:"json",success:function(e){var t=e&&e.devices;t&&0!=t.length&&(n.sourceData.devices=t,n.sourceData.links=e.links||[],r.resize(n))},error:function(e){if(405===e.status){if(0===t)return;t--,s("POST")}}})};s()},resize:function(e){var t=e.graph,n=t.getModel();t.removeCells(t.getDefaultParent().children),n.beginUpdate();try{this.insertDevice(e),this.insertLink(e)}finally{n.endUpdate(),this.collapseGroup(e),this.setCount(e),this.setInspectCount(e)}},insertDevice:function(e){var n=this,r=e.graph,t=e.sourceData.devices,s=e.$el.width();h.each(t,function(e,t){t.group?n.insertGroup(r,t,s):n.insertCell(r,t,s)})},insertCell:function(n,r,e){var s=r.x,t=r.cells.length;"center"===s&&(s=(e-t*r.width-r.margin*(t-1))/2),h.each(r.cells,function(e,t){n.insertVertex(null,null,t,t.x||s+r.margin*e,t.y||r.y,t.width||r.width,t.height||r.height,t.style||r.style)})},insertGroup:function(a,l,e){var o=this,t=l.x,n=l.cells.length,c=o.props.arrange;if("center"===t){var r=0;h.each(l.cells,function(e,t){r+=t.width||l.width}),t=(e-r-l.margin*(n-1))/2+(l.offset||0)*n}h.each(l.cells,function(e,r){void 0===r.collapse&&(r.collapse=l.collapse||!1);var s=r.arrange||l.arrange,i=a.insertVertex(null,null,r,r.x||t+l.margin*e,r.y||l.y,r.width||l.width,r.height||l.height,r.style||l.style);i.group=!0,h.each(r.cells,function(e,t){var n={X:t.x||r.cellX||l.cellX,Y:t.y||r.cellY||l.cellY};s===c.circle?n=o.getPointInCircle(e,r.cells.length,r.width||l.width):s===c.grid&&(n=o.getThePointFun(r.cellX||l.cellX,r.cellY||l.cellY,r.cellMargin||l.cellMargin,r.cellMargin||l.cellMargin,e,r.cellColumn||l.cellColumn)),a.insertVertex(i,null,t,n.X,n.Y,t.width||r.cellWidth||l.cellWidth,t.height||r.cellHeight||l.cellHeight,t.style||r.cellStyle||l.cellStyle)})})},insertLink:function(s){var i=this,e=s.sourceData.links,a=i.props.linkStyle.link;h.each(e,function(e,t){var n=i.getVertexById(s,t.DeviceRootID),r=i.getVertexById(s,t.PeerDeviceRootID);n&&r&&s.graph.insertEdge(null,null,t,n,r,t.style||a)})},getThePointFun:function(e,t,n,r,s,i){var a={},l=Math.floor(s/i);return a.X=(s-l*i)*n+e,a.Y=l*r+t,a},getPointInCircle:function(e,t,n){var r=n/t,s=2*Math.PI/n*r*e,i=n/2;return{X:i+Math.sin(s)*i,Y:i-Math.cos(s)*i}},collapseGroup:function(e){var t=e.mxHelper.getVertexs(!0,function(e){return e.value.collapse});e.graph.foldCells(!0,!0,t)},getVertexById:function(e,t){return e.mxHelper.getVertexs(!0,function(e){return e.value&&e.value.ID==t})[0]},setCount:function(s){var i=this,e=s.mxHelper.getVertexs(!0),a=this.props.deviceCategory.snc,l=this.props.deviceCategory.router,o=this.props.deviceCategory.fp,c=this.props.linkStyle.link_error,u=0,p=0,g=0,d=0,t=function(n){return h.grep(e,function(e,t){return e.value.Category===n}).length},n=function(e,t){return 0===e&&0===t?"0%":r(e/(e+t),1,!0)+"%"};h.each(s.sourceData.links,function(e,t){var n=i.getVertexById(s,t.DeviceRootID),r=i.getVertexById(s,t.PeerDeviceRootID);n&&r&&((n.value.Category===l&&r.value.Category===l||n.value.Category===l&&r.value.Category===a||n.value.Category===a&&r.value.Category===l)&&(t.style===c?p++:u++),(n.value.Category===l&&r.value.Category===o||n.value.Category===o&&r.value.Category===l)&&(t.style===c?d++:g++))}),h("#fpRegCount").text(t(a)),h("#routerCount").text(t(l)),h("#fpCount").text(t(o)),h("#routerLinked").text(u),h("#routerUnlinked").text(p),h("#routerRate").text(n(u,p)),h("#fpLinked").text(g),h("#fpUnlinked").text(d),h("#fpRate").text(n(g,d))},setInspectCount:function(e){var t=e.mxHelper.getCells(!0),n=h.map(h.grep(t,function(e){return e.value&&e.value.inspectResult}),function(e){return e.value.inspectResult}),r={fatal:0,serious:0,commonly:0},s=this.props.inspectLevel;h.each(n,function(e,t){t.level===s.fatal?r.fatal++:t.level===s.serious?r.serious++:r.commonly++}),h.each(s,function(e,t){h('.status[data-level="'+t+'"] .value').text(r[e])})}},a=function(i,s){var e={},a=function(e,n,r){var t=i.getChildVertices(e);0<t.length&&(h.merge(n,t),r&&h.each(t,function(e,t){a(t,n,r)}))},l=function(e,n,r){var t=i.getChildEdges(e);if(0<t.length&&(h.merge(n,t),r)){var s=i.getChildVertices(e);h.each(s,function(e,t){l(t,n,r)})}};return e.getVertexs=function(e,t){var n=s.getDefaultParent(),r=[];return a(n,r,e),t?h.grep(r,t):r},e.getEdges=function(e,t){var n=s.getDefaultParent(),r=[];return l(n,r,e),t?h.grep(r,t):r},e.getCells=function(e,t){var n=this.getVertexs(e).concat(this.getEdges(e));return t?h.grep(n,t):n},e},l=function(e,t){this.instanceId=i.name+(new Date).valueOf(),this.dom=e,this.$el=h(e),this.options=h.extend({},n,t),this.init()};return l.prototype={constructor:l,init:function(){i.init(this)},resize:function(){i.resize(this)}},h.fn.topoViewer=function(t,e){return"string"==typeof t?h.fn.topoViewer.methods[t](this[0],e):this.each(function(){var e=new l(this,t);return h.data(this,i.name,e),e})},h.fn.topoViewer.methods={instance:function(e){return h.data(e,i.name)},options:function(e){return this.instance(e).options},resize:function(e){return this.instance(e).resize()}},h.fn.topoViewer.defaults=n,l});